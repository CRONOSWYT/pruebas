<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproducir Video - MiTube</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .player {
            max-width: 900px;
            margin: auto;
            background: #0b0b0b;
            border-radius: 10px;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        video {
            width: 100%;
            display: block;
            background: #000;
            cursor: pointer;
        }

        .video-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            background: #000;
        }

        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .video-container:hover .play-overlay {
            opacity: 0.8;
        }

        .controls {
            display: flex;
            flex-direction: column;
            background: linear-gradient(to top, #111, #222);
            padding: 10px;
            gap: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #00bfff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        .controls-bottom {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #00bfff;
            border: none;
            color: white;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #00a8d8;
        }

        button:active {
            background: #0088aa;
        }

        input[type="range"] {
            cursor: pointer;
            height: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #00bfff;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #00bfff;
            cursor: pointer;
            border: none;
        }

        .time-display {
            color: #fff;
            font-size: 13px;
            white-space: nowrap;
            min-width: 60px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .speed-control {
            position: relative;
            display: inline-block;
        }

        .speed-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: #222;
            border: 1px solid #00bfff;
            border-radius: 5px;
            display: none;
            flex-direction: column;
            z-index: 100;
            min-width: 60px;
        }

        .speed-menu.active {
            display: flex;
        }

        .speed-menu button {
            width: 100%;
            margin: 2px 0;
            padding: 4px 8px;
            text-align: center;
            background: #333;
            border: none;
            border-radius: 0;
            color: #fff;
        }

        .speed-menu button:hover {
            background: #00bfff;
        }

        .speed-menu button.active {
            background: #00bfff;
        }

        .spacer {
            flex: 1;
        }

        .bookmarks-list {
            background: #1a1a1a;
            border: 1px solid #00bfff;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .bookmark-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #333;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .bookmark-item:hover {
            background: #00bfff33;
        }

        .bookmark-time {
            color: #00bfff;
            font-weight: bold;
            min-width: 50px;
        }

        .bookmark-description {
            flex: 1;
            margin-left: 10px;
            word-break: break-all;
        }

        .bookmark-delete {
            background: #ff4444;
            border: none;
            color: white;
            padding: 3px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
        }

        .bookmark-delete:hover {
            background: #cc0000;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid #00bfff;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.5);
        }

        .modal-title {
            color: #00bfff;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .modal-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: #222;
            border: 1px solid #00bfff;
            color: #fff;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .modal-input::placeholder {
            color: #888;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .quality-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: #222;
            border: 1px solid #00bfff;
            border-radius: 5px;
            display: none;
            flex-direction: column;
            z-index: 100;
            min-width: 80px;
        }

        .quality-menu.active {
            display: flex;
        }

        .quality-menu button {
            width: 100%;
            margin: 2px 0;
            padding: 4px 8px;
            text-align: center;
            background: #333;
            border: none;
            border-radius: 0;
            color: #fff;
        }

        .quality-menu button:hover {
            background: #00bfff;
        }

        .quality-menu button.active {
            background: #00bfff;
        }

        .subtitle-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: #222;
            border: 1px solid #00bfff;
            border-radius: 5px;
            display: none;
            flex-direction: column;
            z-index: 100;
            min-width: 100px;
        }

        .subtitle-menu.active {
            display: flex;
        }

        .subtitle-menu button {
            width: 100%;
            margin: 2px 0;
            padding: 4px 8px;
            text-align: center;
            background: #333;
            border: none;
            border-radius: 0;
            color: #fff;
        }

        .subtitle-menu button:hover {
            background: #00bfff;
        }

        .subtitle-menu button.active {
            background: #00bfff;
        }

        .info-panel {
            display: none;
            background: #1a1a1a;
            border: 1px solid #00bfff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            color: #fff;
            font-size: 13px;
            line-height: 1.6;
        }

        .info-panel.active {
            display: block;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #00bfff;
            font-weight: bold;
        }

        .player-wrapper {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .video-details {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .video-details h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }

        .video-details-meta {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .video-details-meta span {
            margin-right: 15px;
        }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">üé¨ MiTube</a>
    <div style="flex: 1;"></div>
    <button class="btn-back" onclick="window.history.back()">‚Üê Volver</button>
</header>

<div class="player-wrapper">
    <div class="player" id="player">
        <div class="video-container" id="videoContainer">
            <video id="video">
                <source src="" type="video/mp4">
            </video>
            <div class="play-overlay" id="playOverlay">‚ñ∂</div>
        </div>

        <div class="controls">
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="controls-bottom">
                <button id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂ Reproducir</button>
                
                <div class="volume-control">
                    <button id="volumeBtn" onclick="toggleMute()">üîä</button>
                    <input type="range" id="volumeSlider" min="0" max="100" value="100" 
                           style="width: 60px; cursor: pointer;" onchange="setVolume()">
                </div>

                <div class="time-display">
                    <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                </div>

                <div class="spacer"></div>

                <div class="speed-control">
                    <button id="speedBtn" onclick="toggleSpeedMenu()">‚ö° 1x</button>
                    <div class="speed-menu" id="speedMenu">
                        <button class="speed-option" data-speed="0.25">0.25x</button>
                        <button class="speed-option" data-speed="0.5">0.5x</button>
                        <button class="speed-option" data-speed="0.75">0.75x</button>
                        <button class="speed-option active" data-speed="1">Normal</button>
                        <button class="speed-option" data-speed="1.25">1.25x</button>
                        <button class="speed-option" data-speed="1.5">1.5x</button>
                        <button class="speed-option" data-speed="2">2x</button>
                    </div>
                </div>

                <div class="quality-control" style="position: relative;">
                    <button id="qualityBtn" onclick="toggleQualityMenu()">üì∫ Auto</button>
                    <div class="quality-menu" id="qualityMenu">
                        <button class="quality-option active" data-quality="auto">Auto</button>
                        <button class="quality-option" data-quality="1080">1080p</button>
                        <button class="quality-option" data-quality="720">720p</button>
                        <button class="quality-option" data-quality="480">480p</button>
                        <button class="quality-option" data-quality="360">360p</button>
                    </div>
                </div>

                <div class="subtitle-control" style="position: relative;">
                    <button id="subtitleBtn" onclick="toggleSubtitleMenu()">üìù CC</button>
                    <div class="subtitle-menu" id="subtitleMenu">
                        <button class="subtitle-option active" data-subtitle="off">Desactivado</button>
                        <button class="subtitle-option" data-subtitle="es">Espa√±ol</button>
                        <button class="subtitle-option" data-subtitle="en">Ingl√©s</button>
                    </div>
                </div>

                <button id="infoBtn" onclick="toggleInfo()">‚ÑπÔ∏è Info</button>
                <button onclick="togglePiP()">üñº PiP</button>
                <button onclick="toggleFullscreen()">‚õ∂ Pantalla</button>
                <button onclick="openBookmarkDialog()">üìå Marcador</button>
                <button onclick="toggleBookmarks()">üìã Marcadores</button>
            </div>
        </div>
        
        <div class="bookmarks-list" id="bookmarksList" style="display: none;">
            <div id="bookmarksContainer"></div>
        </div>

        <div class="info-panel" id="infoPanel">
            <div class="info-row">
                <span class="info-label">Nombre:</span>
                <span id="videoName">Video</span>
            </div>
            <div class="info-row">
                <span class="info-label">Duraci√≥n:</span>
                <span id="videoDuration">0:00</span>
            </div>
            <div class="info-row">
                <span class="info-label">Resoluci√≥n:</span>
                <span id="videoResolution">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Velocidad reproducci√≥n:</span>
                <span id="videoSpeed">1x</span>
            </div>
            <div class="info-row">
                <span class="info-label">Volumen:</span>
                <span id="videoVolume">100%</span>
            </div>
            <div class="info-row">
                <span class="info-label">Buffering:</span>
                <span id="videoBuffering">0%</span>
            </div>
            <div class="info-row">
                <span class="info-label">Marcadores:</span>
                <span id="bookmarkCount">0</span>
            </div>
        </div>
    </div>

    <div class="video-details">
        <h2 id="videoTitle"></h2>
        <div class="video-details-meta">
            <span id="videoAuthor"></span>
            <span id="videoDate"></span>
            <span id="videoViews"></span>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; margin-top: 20px;">
        <div>
            <!-- Botones de playlist -->
            <div id="playlist-controls" style="display: none; margin-bottom: 15px; gap: 10px; display: flex;">
                <button id="prevPlaylistBtn" onclick="playPreviousVideo()" style="display: none; flex: 1;">‚¨Ö Video Anterior</button>
                <button id="nextPlaylistBtn" onclick="playNextVideo()" style="display: none; flex: 1;">Siguiente Video ‚û°</button>
            </div>
        </div>

        <!-- Panel lateral (Playlist o Recomendados) -->
        <div id="sidebar-panel" class="sidebar-panel"></div>
    </div>
</div>

<div class="modal-overlay" id="bookmarkModal">
    <div class="modal-content">
        <div class="modal-title">Nuevo Marcador</div>
        <div style="margin-bottom: 10px; color: #00bfff;">Tiempo: <span id="bookmarkTime">0:00</span></div>
        <input type="text" id="bookmarkInput" class="modal-input" placeholder="Descripci√≥n del marcador (ej: Introducci√≥n importante)" autofocus>
        <div class="modal-buttons">
            <button onclick="closeBookmarkDialog()">Cancelar</button>
            <button onclick="saveBookmark()">Guardar Marcador</button>
        </div>
    </div>
</div>

<script src="videos.js"></script>
<script>
// Funciones de utilidad
function addToWatchHistory(videoId) {
    let history = JSON.parse(localStorage.getItem("watchHistory")) || [];
    history = history.filter(h => h.videoId !== videoId);
    history.unshift({
        videoId: videoId,
        timestamp: new Date().toISOString()
    });
    history = history.slice(0, 50);
    localStorage.setItem("watchHistory", JSON.stringify(history));
}

function formatUploadDate(date) {
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return "Hoy";
    if (diffDays === 1) return "Ayer";
    if (diffDays < 7) return `Hace ${diffDays} d√≠as`;
    if (diffDays < 30) return `Hace ${Math.floor(diffDays / 7)} semanas`;
    if (diffDays < 365) return `Hace ${Math.floor(diffDays / 30)} meses`;
    return `Hace ${Math.floor(diffDays / 365)} a√±os`;
}

const video = document.getElementById("video");
const videoContainer = document.getElementById("videoContainer");
const player = document.getElementById("player");
const playPauseBtn = document.getElementById("playPauseBtn");
const progressBar = document.getElementById("progressBar");
const progressFill = document.getElementById("progressFill");
const currentTimeSpan = document.getElementById("currentTime");
const durationSpan = document.getElementById("duration");
const volumeBtn = document.getElementById("volumeBtn");
const volumeSlider = document.getElementById("volumeSlider");
const speedBtn = document.getElementById("speedBtn");
const speedMenu = document.getElementById("speedMenu");
const speedOptions = document.querySelectorAll(".speed-option");
const bookmarkModal = document.getElementById("bookmarkModal");
const bookmarkInput = document.getElementById("bookmarkInput");
const bookmarksList = document.getElementById("bookmarksList");
const bookmarksContainer = document.getElementById("bookmarksContainer");
const bookmarkTimeSpan = document.getElementById("bookmarkTime");
const infoPanel = document.getElementById("infoPanel");
const qualityMenu = document.getElementById("qualityMenu");
const qualityOptions = document.querySelectorAll(".quality-option");
const subtitleMenu = document.getElementById("subtitleMenu");
const subtitleOptions = document.querySelectorAll(".subtitle-option");

let bookmarks = JSON.parse(localStorage.getItem("videoBookmarks")) || [];

// Obtener video de URL
const params = new URLSearchParams(window.location.search);
const videoId = parseInt(params.get("id"));
const playlistId = parseInt(params.get("playlist")) || null;
const currentVideo = videos.find(v => v.id === videoId);

let currentPlaylistVideos = [];
let currentVideoIndex = 0;

if (!currentVideo) {
    document.body.innerHTML = "<p style='padding: 20px; color: #aaa;'>Error: Video no encontrado</p>";
} else {
    // Si viene de una playlist
    if (playlistId) {
        const playlist = playlists.find(p => p.id === playlistId);
        if (playlist) {
            currentPlaylistVideos = getVideosByIds(playlist.videos);
            currentVideoIndex = currentPlaylistVideos.findIndex(v => v.id === videoId);
            loadPlaylistPanel(playlist);
        }
    } else {
        // Si viene de inicio, mostrar videos recomendados
        loadRecommendedVideos();
    }
    
    // Cargar video
    video.src = currentVideo.src;
    document.getElementById("videoTitle").textContent = currentVideo.title;
    document.getElementById("videoAuthor").textContent = "Por " + currentVideo.author;
    document.getElementById("videoDate").textContent = formatUploadDate(currentVideo.uploadDate);
    document.getElementById("videoViews").textContent = "";  // Sin vistas
    document.getElementById("videoName").textContent = currentVideo.title;
    
    // Agregar al historial
    addToWatchHistory(videoId);
}

// Panel de playlist
function loadPlaylistPanel(playlist) {
    const container = document.getElementById("sidebar-panel");
    container.innerHTML = `
        <div style="padding: 15px; border-bottom: 1px solid #303030;">
            <h3 style="margin: 0 0 5px 0; font-size: 16px;">‚ñ∂ ${playlist.title}</h3>
            <p style="margin: 0; color: #aaa; font-size: 12px;">Video ${currentVideoIndex + 1} de ${currentPlaylistVideos.length}</p>
        </div>
    `;

    const videosList = document.createElement("div");
    currentPlaylistVideos.forEach((v, index) => {
        const isActive = v.id === videoId;
        const item = document.createElement("div");
        item.className = `playlist-video-item ${isActive ? 'active' : ''}`;
        item.innerHTML = `
            <span class="video-number">${index + 1}</span>
            <div class="video-info-small">
                <p class="video-title-small">${v.title}</p>
                <p class="video-duration-small">${v.duration}</p>
            </div>
        `;
        item.addEventListener("click", () => {
            window.location.href = `video.html?id=${v.id}&playlist=${playlistId}`;
        });
        videosList.appendChild(item);
    });
    container.appendChild(videosList);

    // Mostrar botones de siguiente/anterior
    showPlaylistControls();
}

// Videos recomendados
function loadRecommendedVideos() {
    const container = document.getElementById("sidebar-panel");
    container.innerHTML = `
        <div style="padding: 15px; border-bottom: 1px solid #303030;">
            <h3 style="margin: 0; font-size: 16px;">Videos Recomendados</h3>
        </div>
    `;

    const videosList = document.createElement("div");
    const recommended = videos.slice(0, 8); // √öltimos 8 videos (m√°s recientes)
    
    recommended.forEach(v => {
        if (v.id !== videoId) { // No mostrar el video actual
            const item = document.createElement("div");
            item.className = "recommended-video-item";
            item.innerHTML = `
                <img src="${v.thumbnail}" alt="${v.title}" class="recommended-thumbnail">
                <div class="recommended-info">
                    <p class="recommended-title">${v.title}</p>
                    <p class="recommended-author">${v.author}</p>
                </div>
            `;
            item.addEventListener("click", () => {
                window.location.href = `video.html?id=${v.id}`;
            });
            videosList.appendChild(item);
        }
    });
    container.appendChild(videosList);
}

// Mostrar controles de playlist
function showPlaylistControls() {
    const prevBtn = document.getElementById("prevPlaylistBtn");
    const nextBtn = document.getElementById("nextPlaylistBtn");
    
    if (prevBtn && nextBtn) {
        prevBtn.style.display = currentVideoIndex > 0 ? "block" : "none";
        nextBtn.style.display = currentVideoIndex < currentPlaylistVideos.length - 1 ? "block" : "none";
    }
}

// Funciones de navegaci√≥n
function playPreviousVideo() {
    if (currentVideoIndex > 0 && playlistId) {
        const prevVideo = currentPlaylistVideos[currentVideoIndex - 1];
        window.location.href = `video.html?id=${prevVideo.id}&playlist=${playlistId}`;
    }
}

function playNextVideo() {
    if (currentVideoIndex < currentPlaylistVideos.length - 1 && playlistId) {
        const nextVideo = currentPlaylistVideos[currentVideoIndex + 1];
        window.location.href = `video.html?id=${nextVideo.id}&playlist=${playlistId}`;
    }
}

// Click en el video para pausar/despausar
videoContainer.addEventListener("click", togglePlayPause);

// Inicializar duraci√≥n
video.addEventListener("loadedmetadata", () => {
    durationSpan.textContent = formatTime(video.duration);
    document.getElementById("videoDuration").textContent = formatTime(video.duration);
    updateVideoResolution();
});

// Actualizar buffering
video.addEventListener("progress", updateBuffering);

// Reproducir/Pausar
function togglePlayPause() {
    if (video.paused) {
        video.play();
    } else {
        video.pause();
    }
    updatePlayPauseButton();
}

video.addEventListener("play", updatePlayPauseButton);
video.addEventListener("pause", updatePlayPauseButton);

function updatePlayPauseButton() {
    playPauseBtn.textContent = video.paused ? "‚ñ∂ Reproducir" : "‚è∏ Pausar";
}

// Actualizar progreso
video.addEventListener("timeupdate", () => {
    progressFill.style.width = (video.currentTime / video.duration) * 100 + "%";
    currentTimeSpan.textContent = formatTime(video.currentTime);
    document.getElementById("videoSpeed").textContent = video.playbackRate + "x";
});

// Barra de progreso clickeable
progressBar.addEventListener("click", (e) => {
    const rect = progressBar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    video.currentTime = percent * video.duration;
});

// Control de volumen
function setVolume() {
    video.volume = volumeSlider.value / 100;
    document.getElementById("videoVolume").textContent = Math.round(video.volume * 100) + "%";
}

function toggleMute() {
    if (video.volume > 0) {
        volumeSlider.value = 0;
    } else {
        volumeSlider.value = 50;
    }
    setVolume();
    updateVolumeButton();
}

video.addEventListener("volumechange", updateVolumeButton);

function updateVolumeButton() {
    if (video.volume === 0 || video.muted) {
        volumeBtn.textContent = "üîá";
    } else if (video.volume < 0.5) {
        volumeBtn.textContent = "üîâ";
    } else {
        volumeBtn.textContent = "üîä";
    }
}

// Control de velocidad
function toggleSpeedMenu() {
    speedMenu.classList.toggle("active");
}

speedOptions.forEach(option => {
    option.addEventListener("click", () => {
        const speed = parseFloat(option.dataset.speed);
        video.playbackRate = speed;
        
        speedOptions.forEach(o => o.classList.remove("active"));
        option.classList.add("active");
        speedBtn.textContent = "‚ö° " + speed + "x";
        speedMenu.classList.remove("active");
    });
});

// Control de calidad
function toggleQualityMenu() {
    qualityMenu.classList.toggle("active");
}

qualityOptions.forEach(option => {
    option.addEventListener("click", () => {
        const quality = option.dataset.quality;
        qualityOptions.forEach(o => o.classList.remove("active"));
        option.classList.add("active");
        document.getElementById("qualityBtn").textContent = "üì∫ " + (quality === "auto" ? "Auto" : quality + "p");
        qualityMenu.classList.remove("active");
    });
});

// Control de subt√≠tulos
function toggleSubtitleMenu() {
    subtitleMenu.classList.toggle("active");
}

subtitleOptions.forEach(option => {
    option.addEventListener("click", () => {
        const subtitle = option.dataset.subtitle;
        subtitleOptions.forEach(o => o.classList.remove("active"));
        option.classList.add("active");
        const labels = { off: "CC", es: "ES", en: "EN" };
        document.getElementById("subtitleBtn").textContent = "üìù " + labels[subtitle];
        subtitleMenu.classList.remove("active");
    });
});

// Informaci√≥n del video
function toggleInfo() {
    infoPanel.classList.toggle("active");
    document.getElementById("bookmarkCount").textContent = bookmarks.length;
}

function updateVideoResolution() {
    const width = video.videoWidth;
    const height = video.videoHeight;
    if (width && height) {
        document.getElementById("videoResolution").textContent = `${width}x${height}`;
    }
}

function updateBuffering() {
    if (video.buffered.length > 0) {
        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
        const bufferedPercent = (bufferedEnd / video.duration) * 100;
        document.getElementById("videoBuffering").textContent = Math.round(bufferedPercent) + "%";
    }
}

// Sistema de Marcadores
function openBookmarkDialog() {
    bookmarkTimeSpan.textContent = formatTime(video.currentTime);
    bookmarkInput.value = "";
    bookmarkModal.classList.add("active");
    bookmarkInput.focus();
}

function closeBookmarkDialog() {
    bookmarkModal.classList.remove("active");
}

function saveBookmark() {
    const description = bookmarkInput.value.trim() || "Marcador sin descripci√≥n";
    const bookmark = {
        time: video.currentTime,
        description: description,
        id: Date.now()
    };
    bookmarks.push(bookmark);
    localStorage.setItem("videoBookmarks", JSON.stringify(bookmarks));
    renderBookmarks();
    closeBookmarkDialog();
}

function deleteBookmark(id) {
    bookmarks = bookmarks.filter(b => b.id !== id);
    localStorage.setItem("videoBookmarks", JSON.stringify(bookmarks));
    renderBookmarks();
}

function renderBookmarks() {
    bookmarksContainer.innerHTML = "";
    if (bookmarks.length === 0) {
        bookmarksContainer.innerHTML = '<div style="color: #888; padding: 10px; text-align: center;">No hay marcadores</div>';
        return;
    }
    
    bookmarks.forEach(bookmark => {
        const item = document.createElement("div");
        item.className = "bookmark-item";
        item.innerHTML = `
            <span class="bookmark-time">${formatTime(bookmark.time)}</span>
            <span class="bookmark-description">${escapeHtml(bookmark.description)}</span>
            <button class="bookmark-delete" onclick="deleteBookmark(${bookmark.id})">‚úï</button>
        `;
        item.addEventListener("click", (e) => {
            if (!e.target.classList.contains("bookmark-delete")) {
                video.currentTime = bookmark.time;
                video.play();
                if (document.fullscreenElement) {
                    showControlsInFullscreen();
                }
            }
        });
        bookmarksContainer.appendChild(item);
    });
}

function toggleBookmarks() {
    bookmarksList.style.display = bookmarksList.style.display === "none" ? "block" : "none";
    if (bookmarksList.style.display === "block") {
        renderBookmarks();
    }
}

function escapeHtml(text) {
    const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Controles en pantalla completa
let hideControlsTimeout;
function showControlsInFullscreen() {
    if (document.fullscreenElement) {
        const controls = document.querySelector(".controls");
        const progressBar = document.getElementById("progressBar");
        controls.classList.add("visible");
        progressBar.style.display = "block";
        
        clearTimeout(hideControlsTimeout);
        hideControlsTimeout = setTimeout(() => {
            if (!video.paused) {
                controls.classList.remove("visible");
                progressBar.style.display = "none";
            }
        }, 3000);
    }
}

document.addEventListener("mousemove", () => {
    if (document.fullscreenElement) {
        showControlsInFullscreen();
    }
});

video.addEventListener("play", () => {
    if (document.fullscreenElement) {
        showControlsInFullscreen();
    }
});

video.addEventListener("pause", () => {
    if (document.fullscreenElement) {
        const controls = document.querySelector(".controls");
        const progressBar = document.getElementById("progressBar");
        controls.classList.add("visible");
        progressBar.style.display = "block";
    }
});

// Picture in Picture
async function togglePiP() {
    try {
        if (document.pictureInPictureElement) {
            await document.exitPictureInPicture();
        } else if (document.pictureInPictureEnabled) {
            await video.requestPictureInPicture();
        }
    } catch (error) {
        console.log("PiP no disponible:", error);
    }
}

// Pantalla completa
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        player.requestFullscreen().catch(err => {
            console.log("Error al entrar en pantalla completa:", err);
        });
    } else {
        document.exitFullscreen();
    }
}

// Cerrar modal con ESC
document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
        if (bookmarkModal.classList.contains("active")) {
            closeBookmarkDialog();
        } else if (qualityMenu.classList.contains("active")) {
            qualityMenu.classList.remove("active");
        } else if (subtitleMenu.classList.contains("active")) {
            subtitleMenu.classList.remove("active");
        } else if (speedMenu.classList.contains("active")) {
            speedMenu.classList.remove("active");
        } else if (document.fullscreenElement) {
            document.exitFullscreen();
        }
    }
});

// Atajos de teclado
document.addEventListener("keydown", (e) => {
    if (e.target === document.body || e.target === video) {
        if (e.code === "Space") {
            e.preventDefault();
            togglePlayPause();
        } else if (e.code === "ArrowRight") {
            video.currentTime = Math.min(video.currentTime + 5, video.duration);
        } else if (e.code === "ArrowLeft") {
            video.currentTime = Math.max(video.currentTime - 5, 0);
        } else if (e.code === "ArrowUp") {
            e.preventDefault();
            video.volume = Math.min(video.volume + 0.1, 1);
            volumeSlider.value = video.volume * 100;
            setVolume();
        } else if (e.code === "ArrowDown") {
            e.preventDefault();
            video.volume = Math.max(video.volume - 0.1, 0);
            volumeSlider.value = video.volume * 100;
            setVolume();
        } else if (e.key === "m" || e.key === "M") {
            toggleMute();
        } else if (e.key === "f" || e.key === "F") {
            toggleFullscreen();
        } else if (e.key === "p" || e.key === "P") {
            togglePiP();
        } else if (e.key === "b" || e.key === "B") {
            openBookmarkDialog();
        } else if (e.key === "i" || e.key === "I") {
            toggleInfo();
        } else if (e.key === "t" || e.key === "T") {
            toggleBookmarks();
        } else if (e.code === "KeyJ") {
            video.currentTime = Math.max(video.currentTime - 10, 0);
        } else if (e.code === "KeyL") {
            video.currentTime = Math.min(video.currentTime + 10, video.duration);
        } else if (e.code === "Digit0") {
            video.playbackRate = 1;
            speedOptions.forEach(o => o.classList.remove("active"));
            speedOptions.forEach(o => {
                if (parseFloat(o.dataset.speed) === 1) o.classList.add("active");
            });
        } else if (e.code === "Digit1" || e.code === "Digit9") {
            const amount = e.code === "Digit1" ? 0.25 : -0.25;
            video.playbackRate = Math.max(0.25, Math.min(2, video.playbackRate + amount));
        }
    }
});

// Cerrar men√∫s al hacer clic fuera
document.addEventListener("click", (e) => {
    if (!e.target.closest(".speed-control")) {
        speedMenu.classList.remove("active");
    }
    if (!e.target.closest(".quality-control")) {
        qualityMenu.classList.remove("active");
    }
    if (!e.target.closest(".subtitle-control")) {
        subtitleMenu.classList.remove("active");
    }
});

// Funci√≥n para formatear tiempo
function formatTime(seconds) {
    if (!isFinite(seconds)) return "0:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60).toString().padStart(2, "0");
    return `${mins}:${secs}`;
}

// Inicializar
updatePlayPauseButton();
setVolume();
updateVolumeButton();
</script>

</body>
</html>
